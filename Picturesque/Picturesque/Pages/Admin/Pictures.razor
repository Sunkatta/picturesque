@page "/pictures"
@using System.Net.Http.Headers;
@using Picturesque.Models.Constants;
@inject HttpClient Http;
@inject TokenAuthenticationStateProvider TokenProvider;
@inject NavigationManager UriHelper;
@inject IFileReaderService fileReaderService;
@attribute [Authorize]

<h3>Pictures</h3>

@if (pictures == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row justify-content-end mr-3 mt-4">
        <button class="btn btn-primary"
                @onclick="OnAddPicture">
            Add new picture
        </button>
    </div>
    @if (addingPicture)
    {
        <div class="row mt-2">
            <div class="col-md-6">
                <input class="form-control" type="file" multiple @ref=inputTypeFileElement />
            </div>
            <div class="col-md-6">
                <button class="btn btn-outline-success" @onclick=UploadFiles>Upload files</button>
            </div>
        </div>
    }
    @if (editingPicture)
    {
        <EditForm Model="picture" OnValidSubmit="AddCategoryToPicture">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group row mt-4">
                <label>Select Category</label>
                <InputSelect class="form-control" @bind-Value="picture.CategoryId">
                    <option value="" selected>--</option>
                    @foreach (var category in categories)
                            {
                        <option value="@category.Id">@category.Name</option>
                            }
                    /**/
                    /**/
                    /**/
                </InputSelect>
            </div>
            <div class="form-group row">
                <button type="submit" class="btn btn-outline-success w-100">Add Category</button>
            </div>
        </EditForm>
    }
    <div class="row mt-2">
        @foreach (var picture in pictures)
        {
            <div class="col-md-3" style="border: 1px solid black; padding: 0">
                <img class="img" src="@picture.Img2Base64" />
                <div class="text-center">
                    <p>Category: @picture.CategoryName</p>
                    <div class="p-2">
                        <button class="btn btn-primary" @onclick="() => OnEditPicture(picture.Id)">Edit</button>
                        <button class="btn btn-outline-danger"
                                @onclick="() => DeletePicture(picture.Id)">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private Picture[] pictures;
    private Picture picture = new Picture();
    private Category[] categories;
    private bool addingPicture = false;
    private bool editingPicture = false;
    ElementReference inputTypeFileElement;
    IFileReaderRef fileReaderReference;

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenProvider.GetTokenAsync();
        var isAdmin = (await TokenProvider.GetAuthenticationStateAsync())
            .User
            .Claims
            .FirstOrDefault(c => c.Type.ToString() == "is_admin")?.Value == "True";

        if (token != null && isAdmin)
        {
            try
            {
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
                pictures = await Http.GetJsonAsync<Picture[]>(ApiConstants.ApiUrl + "Picture");
                categories = await Http.GetJsonAsync<Category[]>(ApiConstants.ApiUrl + "Category");
            }
            catch (Exception ex)
            {
                if (ex.Message.Contains("401"))
                {
                    await TokenProvider.SetTokenAsync(null);
                }
            }
        }
        else
        {
            UriHelper.NavigateTo("startgame");
        }
    }

    protected override void OnAfterRender(bool isFirstRender)
    {
        fileReaderReference = fileReaderService.CreateReference(inputTypeFileElement);
    }

    protected void OnAddPicture()
    {
        addingPicture = !addingPicture;
        editingPicture = false;
    }

    protected void OnEditPicture(string pictureId)
    {
        editingPicture = !editingPicture;
        picture = pictures.FirstOrDefault(c => c.Id == pictureId);
    }

    protected async Task UploadFiles()
    {
        var multipartFormDataContent = new MultipartFormDataContent();
        foreach (var file in await fileReaderReference.EnumerateFilesAsync())
        {
            multipartFormDataContent.Add(
                new StreamContent(await file.OpenReadAsync(), 8192),
                "files",
                (await file.ReadFileInfoAsync()).Name);
        }

        var res = await Http.PostAsync(ApiConstants.ApiUrl + "Picture/UploadPictures",
                content: multipartFormDataContent);
        pictures = await Http.GetJsonAsync<Picture[]>(ApiConstants.ApiUrl + "Picture");
    }

    protected async Task AddCategoryToPicture()
    {
        await Http.PostJsonAsync(ApiConstants.ApiUrl + "Picture/UpdatePictureCategory", picture);
        pictures = null;
        pictures = await Http.GetJsonAsync<Picture[]>(ApiConstants.ApiUrl + "Picture");
        editingPicture = false;
        picture = new Picture();
    }

    protected async Task DeletePicture(string pictureId)
    {
        picture = pictures.FirstOrDefault(c => c.Id == pictureId);
        pictures =
            await Http.PostJsonAsync<Picture[]>(ApiConstants.ApiUrl + "Picture/DeletePicture", picture);
        picture = new Picture();
    }
}
